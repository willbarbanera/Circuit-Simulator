<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Lab: Fixed Components</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #1a1a1a; color: white; margin: 0; overflow: hidden; }
        #toolbar { background: #2c3e50; padding: 15px; width: 100%; display: flex; gap: 10px; justify-content: center; border-bottom: 4px solid #34495e; z-index: 100; }
        .tool { padding: 10px 15px; background: #34495e; border: 1px solid #555; color: white; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .tool:hover { background: #465d75; }
        canvas { background: #ffffff; border-radius: 8px; margin-top: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 2px solid #555; }
        #voltage-ctrl { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; display: none; border: 1px solid #3498db; }
        .instruction { color: #888; margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

<div id="toolbar">
    <button class="tool" onclick="spawn('battery')">ðŸ”‹ Add Battery</button>
    <button class="tool" onclick="spawn('bulb')">ðŸ’¡ Add Bulb</button>
    <button class="tool" onclick="spawn('wire')">ðŸ§µ Add Wire</button>
    <button class="tool" onclick="spawn('switch')">ðŸ”Œ Add Switch</button>
    <button class="tool" onclick="clearLab()" style="background: #c0392b;">Reset</button>
</div>

<canvas id="labCanvas" width="900" height="500"></canvas>

<div id="voltage-ctrl">
    <strong>Battery: <span id="v-num">9</span>V</strong><br>
    <input type="range" id="v-slider" min="0" max="30" value="9" oninput="setV(this.value)">
</div>

<p class="instruction">If components don't appear, ensure you are using a modern browser (Chrome, Edge, or Firefox).</p>

<script>
    const canvas = document.getElementById('labCanvas');
    const ctx = canvas.getContext('2d');
    const vCtrl = document.getElementById('voltage-ctrl');
    const vNum = document.getElementById('v-num');

    let components = [];
    let wires = [];
    let dragObj = null;
    let selectedBat = null;
    let eOffset = 0;
    let current = 0;

    // MANDATORY SPAWN FUNCTION
    function spawn(type) {
        // Place in random offset near center so they don't stack perfectly
        const rx = (canvas.width / 2 - 50) + (Math.random() * 40 - 20);
        const ry = (canvas.height / 2 - 30) + (Math.random() * 40 - 20);

        if (type === 'wire') {
            wires.push({ x1: rx - 50, y1: ry, x2: rx + 50, y2: ry });
        } else {
            components.push({
                type, x: rx, y: ry, w: 100, h: 60,
                v: type === 'battery' ? 9 : 0,
                isOpen: type === 'switch' ? true : false
            });
        }
        console.log("Spawned:", type); // Check your browser console (F12) to see this
    }

    function setV(val) {
        if (selectedBat) {
            selectedBat.v = parseFloat(val);
            vNum.innerText = val;
        }
    }

    function checkLoop() {
        let bat = components.find(c => c.type === 'battery');
        if (!bat || bat.v === 0) return 0;
        
        // Simple connectivity check
        let connected = wires.filter(w => {
            let s = components.some(c => Math.hypot(w.x1 - c.x, w.y1 - (c.y + 30)) < 25 || Math.hypot(w.x1 - (c.x + 100), w.y1 - (c.y + 30)) < 25);
            let e = components.some(c => Math.hypot(w.x2 - c.x, w.y2 - (c.y + 30)) < 25 || Math.hypot(w.x2 - (c.x + 100), w.y2 - (c.y + 30)) < 25);
            return s && e;
        });

        const swOpen = components.some(c => c.type === 'switch' && c.isOpen);
        return (connected.length >= components.length && !swOpen) ? bat.v / 10 : 0;
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        current = checkLoop();

        // Draw Wires
        wires.forEach(w => {
            ctx.strokeStyle = "#333"; ctx.lineWidth = 10; ctx.lineCap = "round";
            ctx.beginPath(); ctx.moveTo(w.x1, w.y1); ctx.lineTo(w.x2, w.y2); ctx.stroke();
            
            if (current > 0) {
                ctx.fillStyle = "#f1c40f";
                let dx = w.x2 - w.x1, dy = w.y2 - w.y1, dist = Math.hypot(dx, dy), dots = Math.floor(dist/15);
                for(let i=0; i<dots; i++){
                    let p = ((i/dots) + eOffset) % 1;
                    ctx.beginPath(); ctx.arc(w.x1 + dx*p, w.y1 + dy*p, 3, 0, 7); ctx.fill();
                }
            }
        });

        // Draw Components
        components.forEach(c => {
            // Draw Body
            ctx.fillStyle = c.type === 'battery' ? "#2c3e50" : "#95a5a6";
            if (c.type === 'bulb' && current > 0) {
                ctx.shadowBlur = 20; ctx.shadowColor = "yellow";
                ctx.fillStyle = "#f1c40f";
            }
            ctx.fillRect(c.x + 10, c.y + 10, 80, 40);
            ctx.shadowBlur = 0;

            // Labels
            ctx.fillStyle = "white"; ctx.font = "10px Arial";
            ctx.fillText(c.type.toUpperCase(), c.x + 20, c.y + 35);
            if(c.type === 'battery') ctx.fillText(c.v + "V", c.x + 65, c.y + 35);

            // Terminals
            ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.arc(c.x, c.y + 30, 8, 0, 7); ctx.fill();
            ctx.fillStyle = "#3498db"; ctx.beginPath(); ctx.arc(c.x + 100, c.y + 30, 8, 0, 7); ctx.fill();
        });

        eOffset += current * 0.05;
        requestAnimationFrame(render);
    }

    canvas.onmousedown = (e) => {
        const { offsetX: mx, offsetY: my } = e;
        for (let w of wires) {
            if (Math.hypot(mx - w.x1, my - w.y1) < 20) { dragObj = { obj: w, p: 'x1' }; return; }
            if (Math.hypot(mx - w.x2, my - w.y2) < 20) { dragObj = { obj: w, p: 'x2' }; return; }
        }
        for (let c of components) {
            if (mx > c.x && mx < c.x + 100 && my > c.y && my < c.y + 60) {
                if (c.type === 'switch') { c.isOpen = !c.isOpen; return; }
                if (c.type === 'battery') { selectedBat = c; vCtrl.style.display = 'block'; }
                dragObj = { obj: c, p: 'c', ox: c.x - mx, oy: c.y - my };
                return;
            }
        }
    };

    canvas.onmousemove = (e) => {
        if (!dragObj) return;
        const { offsetX: mx, offsetY: my } = e;
        if (dragObj.p === 'x1') { dragObj.obj.x1 = mx; dragObj.obj.y1 = my; }
        else if (dragObj.p === 'x2') { dragObj.obj.x2 = mx; dragObj.obj.y2 = my; }
        else { dragObj.obj.x = mx + dragObj.ox; dragObj.obj.y = my + dragObj.oy; }
    };

    canvas.onmouseup = () => dragObj = null;
    function clearLab() { components = []; wires = []; vCtrl.style.display = 'none'; }
    
    // Start the engine
    render();
</script>
</body>
</html>