<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realistic Breadboard Lab</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background: #2c3e50; color: #ecf0f1; margin: 0; overflow: hidden; }
        #toolbar { background: #1a252f; padding: 15px; width: 100%; display: flex; gap: 12px; justify-content: center; border-bottom: 4px solid #34495e; z-index: 10; }
        .tool { padding: 10px 18px; background: #34495e; border: 1px solid #555; color: #fff; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .tool:hover { background: #1abc9c; }
        canvas { background: #dcdde1; border-radius: 8px; margin-top: 20px; cursor: crosshair; box-shadow: 0 0 40px rgba(0,0,0,0.5); border: 10px solid #7f8c8d; }
        #ui-overlay { position: absolute; bottom: 20px; left: 20px; background: rgba(26, 37, 47, 0.95); padding: 15px; border-radius: 10px; border: 2px solid #f1c40f; display: none; }
        .hint { margin-top: 10px; color: #bdc3c7; font-size: 0.85rem; }
    </style>
</head>
<body>

<div id="toolbar">
    <button class="tool" onclick="spawn('battery')">ðŸ”‹ Battery</button>
    <button class="tool" onclick="spawn('bulb')">ðŸ’¡ Lightbulb</button>
    <button class="tool" onclick="spawn('wire')">ðŸ§µ Jumper Wire</button>
    <button class="tool" onclick="spawn('switch')">ðŸ”Œ Toggle Switch</button>
    <button class="tool" onclick="clearLab()" style="background: #c0392b;">Reset</button>
</div>

<canvas id="circuitCanvas" width="950" height="520"></canvas>

<div id="ui-overlay">
    <strong>9V Battery Settings</strong><br>
    <label>Voltage: <span id="v-label">9</span>V</label><br>
    <input type="range" id="v-slider" min="0" max="24" value="9" oninput="updateVoltage(this.value)">
</div>

<p class="hint">Ensure all components are <b>Green</b> (Snapped) to complete the circuit. Click the switch to toggle power.</p>

<script>
    const canvas = document.getElementById('circuitCanvas');
    const ctx = canvas.getContext('2d');
    const uiOverlay = document.getElementById('ui-overlay');
    const vLabel = document.getElementById('v-label');

    let components = [];
    let dragTarget = null;
    let currentFlow = 0;
    let eOffset = 0;
    const SNAP_DIST = 22;

    const prongs = [];
    for (let x = 40; x < canvas.width; x += 40) {
        for (let y = 40; y < canvas.height; y += 40) {
            prongs.push({ x, y });
        }
    }

    function spawn(type) {
        components.push({
            type, x1: 400, y1: 240, x2: 520, y2: 240,
            v: type === 'battery' ? 9 : 0,
            isOpen: type === 'switch' ? true : false,
            p1: true, p2: true
        });
    }

    function getNearestProng(x, y) {
        let nearest = null;
        let minDist = SNAP_DIST;
        prongs.forEach(p => {
            let d = Math.hypot(x - p.x, y - p.y);
            if (d < minDist) { minDist = d; nearest = p; }
        });
        return nearest;
    }

    function updateVoltage(val) {
        if (dragTarget && dragTarget.obj.type === 'battery') {
            dragTarget.obj.v = parseFloat(val);
            vLabel.innerText = val;
        }
    }

    function checkCircuit() {
        let battery = components.find(c => c.type === 'battery' && c.v > 0 && c.p1 && c.p2);
        let bulbs = components.filter(c => c.type === 'bulb' && c.p1 && c.p2);
        let switches = components.filter(c => c.type === 'switch');
        
        const anySwitchOpen = switches.some(s => s.isOpen);
        const allConnected = components.every(c => c.p1 && c.p2);

        if (battery && bulbs.length > 0 && allConnected && !anySwitchOpen) {
            return battery.v / 10;
        }
        return 0;
    }

    function drawComponent(c, dist, current) {
        if (c.type === 'battery') {
            // Battery Casing
            ctx.fillStyle = "#333";
            ctx.fillRect(10, -20, dist-20, 40);
            ctx.fillStyle = "#f1c40f";
            ctx.fillRect(10, -20, (dist-20)*0.3, 40); // Label area
            ctx.fillStyle = "white"; ctx.font = "bold 10px Arial";
            ctx.fillText(c.v + "V", 15, 5);
        } 
        else if (c.type === 'bulb') {
            // Socket
            ctx.fillStyle = "#7f8c8d";
            ctx.fillRect(15, -12, dist-30, 24);
            // Glass Bulb
            ctx.beginPath();
            ctx.arc(dist/2, -5, 18, 0, Math.PI * 2);
            if (current > 0) {
                ctx.shadowBlur = 40; ctx.shadowColor = "#f1c40f";
                ctx.fillStyle = "rgba(255, 255, 0, 0.8)";
            } else {
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
            }
            ctx.fill();
            ctx.strokeStyle = "#fff"; ctx.stroke();
            ctx.shadowBlur = 0;
        } 
        else if (c.type === 'switch') {
            // Base
            ctx.fillStyle = "#2c3e50";
            ctx.fillRect(10, -15, dist-20, 30);
            // Lever
            ctx.strokeStyle = "#bdc3c7"; ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(dist*0.3, 0);
            if(c.isOpen) ctx.lineTo(dist*0.6, -25); else ctx.lineTo(dist*0.7, 0);
            ctx.stroke();
        }
        else if (c.type === 'wire') {
            ctx.